//
//  Untitled.swift
//  CoNETVPN1
//
//  Created by peter on 2025-09-05.
//

import Foundation


// --- 广告黑名单（支持精确与前缀 *. 通配后缀匹配） ---
struct AdBlacklist {
    // 可继续扩充；保持短小，命中即废止代理
    static let patterns: [String] = [
        
    ]
    
    static let regexps: [NSRegularExpression] = {
        let raw = [
            "taboola.com"
        ]
        return raw.compactMap { try? NSRegularExpression(pattern: $0, options: [.caseInsensitive]) }
    }()

    @inline(__always)
    static func matches(_ host: String) -> Bool {
        let h = host.lowercased()
        for p in patterns {
            let pat = p.lowercased()
            if pat.hasPrefix("*.") {
                let suf = String(pat.dropFirst(1)) // ".example.com"
                if h.hasSuffix(suf) { return true }
            } else {
                // Match exact domain OR any subdomain
                if h == pat || h.hasSuffix("." + pat) {
                    return true
                }
            }
        }
        // 额外正则匹配
        for re in regexps {
            let range = NSRange(location: 0, length: h.utf16.count)
            if re.firstMatch(in: h, options: [], range: range) != nil {
                return true
            }
        }
        return false
    }
}

// --- 白名单（命中则本地直连，不走 LayerMinus 打包） ---
struct Allowlist {
    // 可按需扩充；示例以常见业务域/必要依赖为主，避免误伤
    static let patterns: [String] = [
        "conet.network",
        "silentpass.io",
        "openpgp.online",
        "comm100vue.com",
        "comm100.io",
        "doubleclick.net",
        "googleadservices.com",
        "googlesyndication.com",
        "googletagmanager.com",
        "googletagservices.com",
        "google-analytics.com",
        "googleanalytics.com",
        "adsystem.com",
        "adsrvr.org",
        "onetrust.com",
        "liadm.com",

        // Facebook/Meta
        "facebook-analytics.com",
        "fbcdn.net",

        // Amazon
        "amazontrust.com",

        // Microsoft
        "adsrvr.org",
        "bing.com",
        "msftconnecttest.com",

        // 通用广告网络
        "adsrvr.org",
        "adnxs.com",
        "adzerk.net",
        "pubmatic.com",
        "criteo.com",
        "criteo.net",
        "casalemedia.com",
        "openx.net",
        "rubiconproject.com",
        "serving-sys.com",
        "taboola.com",
        "outbrain.com",
        "media.net",
        "yieldmo.com",
        "3lift.com",
        "indexexchange.com",
        "sovrn.com",
        "sharethrough.com",
        "spotx.tv",
        "springserve.com",
        "tremor.io",
        "tribalfusion.com",
        "undertone.com",
        "yieldlab.net",
        "yieldmanager.com",
        "zedo.com",
        "zemanta.com",

        // 分析和跟踪
        "scorecardresearch.com",
        "quantserve.com",
        "imrworldwide.com",
        "nielsen.com",
        "alexa.com",
        "hotjar.com",
        "mouseflow.com",
        "luckyorange.com",
        "clicktale.com",
        "demdex.net",
        "krxd.net",
        "bluekai.com",
        "exelator.com",
        "mathtag.com",
        "turn.com",
        "acuityplatform.com",
        "adform.net",
        "bidswitch.net",
        "contextweb.com",
        "districtm.io",
        "emxdgt.com",
        "gumgum.com",
        "improve-digital.com",
        "inmobi.com",
        "loopme.com",
        "mobfox.com",
        "nexage.com",
        "rhythmone.com",
        "smaato.com",
        "smartadserver.com",
        "stroeer.io",
        "teads.tv",
        "triplelift.com",
        "verizonmedia.com",
        "vertamedia.com",
        "video.io",
        "viralize.com",
        "weborama.com",
        "widespace.com",

        // 中国广告网络
        
        "tanx.com",
        "mediav.com",
        "admaster.com.cn",
        "dsp.com",
        "vamaker.com",
        "allyes.com",
        "ipinyou.com",
        "irs01.com",
        "istreamsche.com",
        "jusha.com",
        "knet.cn",
        "madserving.com",
        "miaozhen.com",
        "mmstat.com",
        "moad.cn",
        "mobaders.com",
        "mydas.mobi",
        "n.shifen.com",
        "netease.gg",
        "newrelic.com",
        "nexac.com",
        "ntalker.com",
        "nylalobghyhirgh.com",
        "o2omobi.com",
        "oimagea2.ydstatic.com",
        "optaim.com",
        "optimix.asia",
        "optimizely.com",
        "overture.com",
        "p0y.cn",
        "pagead.l.google.com",
        "pageadimg.l.google.com",
        "pbcdn.com",
        "pingdom.net",
        "pixanalytics.com",
        "ppjia55.com",
        "punchbox.org",
        "qchannel01.cn",
        "qiyou.com",
        "qtmojo.com",
        "quantcount.com",

        // 恶意软件和垃圾邮件
        "2o7.net",
        "omtrdc.net",
        "everesttech.net",
        "everest-tech.net",
        "rubiconproject.com",
        "adsafeprotected.com",
        "adsymptotic.com",
        "adtechjp.com",
        "advertising.com",
        "evidon.com",
        "voicefive.com",
        "buysellads.com",
        "carbonads.com",
        "cdn.ampproject.org",
        "zdbb.net",
        "trackcmp.net",
        

        // 更多跟踪器
        "mixpanel.com",
        "kissmetrics.com",
        "segment.com",
        "segment.io",
        "keen.io",
        "amplitude.com",
        "appsflyer.com",
        "branch.io",
        "adjust.com",
        "kochava.com",
        "tenjin.io",
        "singular.net",
        "apptentive.com",
        "appboy.com",
        "braze.com",
        "customer.io",
        "intercom.io",
        "drift.com",
        "zendesk.com",
        // Apple Push 相关
        "conet.network",
        "apple.com",
        "push.apple.com",
        "cdn-apple.com",
        "cdnst.net",
        "icloud.com",
        "push-apple.com.akadns.net",
        "amazon-adsystem.com",
        "silentpass.io",
        "ziffstatic.com",
        "cdn.ziffstatic.com",
        "courier.push.apple.com",
        "gateway.push.apple.com",
        "gateway.sandbox.push.apple.com",
        "gateway.icloud.com",
        "bag.itunes.apple.com",
        "init.itunes.apple.com",
        "xp.apple.com",
        "gsa.apple.com",
        "gsp-ssl.ls.apple.com",
        "gsp-ssl.ls-apple.com.akadns.net",
        "mesu.apple.com",
        "gdmf.apple.com",
        "deviceenrollment.apple.com",
        "mdmenrollment.apple.com",
        "iprofiles.apple.com",
        "ppq.apple.com",
        "baidu.com",
        "bdstatic.com",

        // 🔥 微信（WeChat）相关域名
        "wechat.com",
        "weixin.qq.com",
        "weixin110.qq.com",
        "tenpay.com",
        "mm.taobao.com",
        "wx.qq.com",
        "web.wechat.com",
        "webpush.weixin.qq.com",
        "qpic.cn",
        "qlogo.cn",
        "wx.gtimg.com",
        "minorshort.weixin.qq.com",
        "log.weixin.qq.com",
        "szshort.weixin.qq.com",
        "szminorshort.weixin.qq.com",
        "szextshort.weixin.qq.com",
        "hkshort.weixin.qq.com",
        "hkminorshort.weixin.qq.com",
        "hkextshort.weixin.qq.com",
        "hklong.weixin.qq.com",
        "sgshort.wechat.com",
        "sgminorshort.wechat.com",
        "sglong.wechat.com",
        "usshort.wechat.com",
        "usminorshort.wechat.com",
        "uslong.wechat.com",

        // 微信支付
        "pay.weixin.qq.com",
        "payapp.weixin.qq.com",

        // 微信文件传输
        "file.wx.qq.com",
        "support.weixin.qq.com",

        // 微信 CDN
        "mmbiz.qpic.cn",
        "mmbiz.qlogo.cn",
        "mmsns.qpic.cn",
        "sync.com",

        // 腾讯推送服务
        "dns.weixin.qq.com",
        "short.weixin.qq.com",
        "long.weixin.qq.com",

        "doubleclick.net",
        "pubmatic.com",
        "adnxs.com",
        "rubiconproject.com",

        "adsrvr.org",
        "criteo.com",

        "taboola.com",
        "yahoo.com",
        "publicsuffix.org"
    ]
    
    static let ipv4CIDRsRaw: [String] = [
        "23.0.0.0/8",
        "143.224.0.0/12",
        "144.178.0.0/15",
        "199.47.192.0/19",
        "38.0.0.0/8",
        "172.67.215.0/24",
        "1.1.1.0/24",
        "8.8.8.0/24",
        "208.67.222.0/24",
        "101.32.0.0/16",
        "101.33.0.0/16",
        "101.89.0.0/16",
        "101.91.0.0/16",
        "101.226.0.0/16",
        "101.227.0.0/16",
        "103.7.28.0/22",
        "109.244.0.0/16",
        "110.52.193.0/24",
        "110.53.0.0/16",
        "111.30.0.0/15",
        "112.53.0.0/16",
        "112.60.0.0/14",
        "112.64.0.0/10",
        "112.90.0.0/15",
        "113.96.0.0/11",
        "115.159.0.0/16",
        "117.184.0.0/13",
        "119.28.0.0/16",
        "119.29.0.0/16",
        "119.147.0.0/16",
        "120.198.0.0/16",
        "120.232.0.0/14",
        "121.51.0.0/16",
        "129.226.0.0/16",
        "140.206.0.0/16",
        "140.207.0.0/16",
        "150.109.0.0/16",
        "162.62.0.0/16",
        "180.96.0.0/15",
        "180.163.0.0/16",
        "182.254.0.0/16",
        "183.192.0.0/10",
        "203.205.128.0/17",
        "211.95.0.0/16",
        "220.196.0.0/14",
        "101.33.10.0/24",
          "101.33.11.0/24",
          "101.33.17.0/24",
          "101.33.18.0/24",
          "101.33.19.0/24",
          "101.33.20.0/24",
          "101.33.21.0/24",
          "101.33.22.0/24",
          "101.33.23.0/24",
          "101.33.24.0/24",
          "101.33.25.0/24",
          "101.33.26.0/24",
          "101.33.27.0/24",
          "101.33.6.0/24",
          "101.33.7.0/24",
          "101.33.8.0/24",
          "101.33.9.0/24",
          "162.14.44.0/24",
          "162.14.45.0/24",
          "162.14.46.0/24",
          "162.14.47.0/24",
          "2.135.121.192/26",
          "211.152.132.0/23",
          "211.152.148.0/24",
          "211.152.149.0/24",
          "43.131.10.0/24",
          "43.131.11.0/24",
          "43.132.64.0/23",
          "43.132.64.0/24",
          "43.132.65.0/24",
          "43.132.66.0/23",
          "43.132.69.0/24",
          "43.132.70.0/23",
          "43.132.72.0/23",
          "43.132.74.0/24",
          "43.132.75.0/24",
          "43.132.77.0/24",
          "43.132.78.0/23",
          "43.132.78.0/24",
          "43.132.79.0/24",
          "43.132.80.0/24",
          "43.132.81.0/24",
          "43.132.82.0/24",
          "43.132.83.0/24",
          "43.132.84.0/24",
          "43.132.85.0/24",
          "43.132.86.0/24",
          "43.132.87.0/24",
          "43.132.89.0/24",
          "43.132.90.0/24",
          "43.132.91.0/24",
          "43.132.93.0/24",
          "43.132.94.0/23",
          "43.152.0.0/24",
          "43.152.1.0/24",
          "43.152.10.0/24",
          "43.152.11.0/24",
          "43.152.12.0/24",
          "43.152.129.0/24",
          "43.152.13.0/24",
          "43.152.130.0/24",
          "43.152.132.0/24",
          "43.152.133.0/24",
          "43.152.134.0/23",
          "43.152.136.0/24",
          "43.152.137.0/24",
          "43.152.138.0/24",
          "43.152.139.0/24",
          "43.152.14.0/24",
          "43.152.140.0/24",
          "43.152.142.0/24",
          "43.152.143.0/24",
          "43.152.144.0/24",
          "43.152.148.0/24",
          "43.152.149.0/24",
          "43.152.15.0/24",
          "43.152.150.0/24",
          "43.152.151.0/24",
          "43.152.152.0/24",
          "43.152.153.0/24",
          "43.152.154.0/24",
          "43.152.155.0/24",
          "43.152.156.0/24",
          "43.152.157.0/24",
          "43.152.158.0/24",
          "43.152.159.0/24",
          "43.152.160.0/24",
          "43.152.161.0/24",
          "43.152.162.0/24",
          "43.152.166.0/24",
          "43.152.168.0/24",
          "43.152.169.0/24",
          "43.152.17.0/24",
          "43.152.170.0/24",
          "43.152.171.0/24",
          "43.152.173.0/24",
          "43.152.174.0/24",
          "43.152.175.0/24",
          "43.152.177.0/24",
          "43.152.178.0/24",
          "43.152.179.0/24",
          "43.152.18.0/24",
          "43.152.180.0/24",
          "43.152.181.0/24",
          "43.152.182.0/24",
          "43.152.183.0/24",
          "43.152.184.0/24",
          "43.152.185.0/24",
          "43.152.186.0/24",
          "43.152.188.0/24",
          "43.152.19.0/24",
          "43.152.190.0/24",
          "43.152.2.0/24",
          "43.152.20.0/24",
          "43.152.21.0/24",
          "43.152.22.0/24",
          "43.152.23.0/24",
          "43.152.24.0/24",
          "43.152.25.0/24",
          "43.152.26.0/24",
          "43.152.27.0/24",
          "43.152.28.0/24",
          "43.152.29.0/24",
          "43.152.3.0/24",
          "43.152.30.0/24",
          "43.152.31.0/24",
          "43.152.32.0/24",
          "43.152.33.0/24",
          "43.152.35.0/24",
          "43.152.36.0/24",
          "43.152.37.0/24",
          "43.152.4.0/24",
          "43.152.40.0/24",
          "43.152.41.0/24",
          "43.152.42.0/23",
          "43.152.44.0/23",
          "43.152.47.0/24",
          "43.152.48.0/24",
          "43.152.49.0/24",
          "43.152.5.0/24",
          "43.152.50.0/24",
          "43.152.51.0/24",
          "43.152.52.0/24",
          "43.152.53.0/24",
          "43.152.55.0/24",
          "43.152.57.0/24",
          "43.152.58.0/23",
          "43.152.6.0/24",
          "43.152.60.0/24",
          "43.152.61.0/24",
          "43.152.62.0/24",
          "43.152.7.0/24",
          "43.152.8.0/24",
          "43.159.102.0/23",
          "43.159.102.0/24",
          "43.159.103.0/24",
          "43.159.104.0/23",
          "43.159.104.0/24",
          "43.159.105.0/24",
          "43.159.106.0/23",
          "43.159.106.0/24",
          "43.159.107.0/24",
          "43.159.108.0/23",
          "43.159.108.0/24",
          "43.159.109.0/24",
          "43.159.110.0/23",
          "43.159.110.0/24",
          "43.159.111.0/24",
          "43.159.112.0/23",
          "43.159.112.0/24",
          "43.159.113.0/24",
          "43.159.114.0/23",
          "43.159.114.0/24",
          "43.159.115.0/24",
          "43.159.116.0/23",
          "43.159.116.0/24",
          "43.159.117.0/24",
          "43.159.118.0/23",
          "43.159.118.0/24",
          "43.159.119.0/24",
          "43.159.120.0/24",
          "43.159.121.0/24",
          "43.159.122.0/24",
          "43.159.123.0/24",
          "43.159.125.0/24",
          "43.159.126.0/24",
          "43.159.127.0/24",
          "43.159.64.0/24",
          "43.159.65.0/24",
          "43.159.69.0/24",
          "43.159.72.0/24",
          "43.159.73.0/24",
          "43.159.74.0/24",
          "43.159.77.0/24",
          "43.159.78.0/24",
          "43.159.79.0/24",
          "43.159.80.0/24",
          "43.159.81.0/24",
          "43.159.82.0/24",
          "43.159.83.0/24",
          "43.159.84.0/24",
          "43.159.85.0/24",
          "43.159.87.0/24",
          "43.159.90.0/24",
          "43.159.94.0/23",
          "43.159.94.0/24",
          "43.159.95.0/24",
          "43.159.97.0/24",
          "43.159.98.0/23",
          "43.159.98.0/24",
          "43.159.99.0/24",
            "43.159.158.0/24",
          "43.168.10.0/24",
          "43.168.14.0/24",
          "43.168.15.0/24",
          "43.168.16.0/24",
          "43.168.17.0/24",
          "43.168.18.0/24",
          "43.168.19.0/24",
          "43.168.20.0/24",
          "43.168.21.0/24",
          "43.168.22.0/24",
          "43.168.23.0/24",
          "43.168.24.0/24",
          "43.168.25.0/24",
          "43.168.32.0/24",
          "43.168.34.0/24",
          "43.168.4.0/24",
          "43.168.5.0/24",
          "43.174.0.0/24",
          "43.174.1.0/24",
          "43.174.10.0/24",
          "43.174.100.0/24",
          "43.174.101.0/24",
          "43.174.102.0/24",
          "43.174.103.0/24",
          "43.174.104.0/24",
          "43.174.105.0/24",
          "43.174.106.0/24",
          "43.174.107.0/24",
          "43.174.108.0/24",
          "43.174.109.0/24",
          "43.174.11.0/24",
          "43.174.118.0/24",
          "43.174.119.0/24",
          "43.174.12.0/24",
          "43.174.122.0/24",
          "43.174.124.0/24",
          "43.174.125.0/24",
          "43.174.126.0/24",
          "43.174.127.0/24",
          "43.174.128.0/24",
          "43.174.129.0/24",
          "43.174.13.0/24",
          "43.174.131.0/24",
          "43.174.134.0/24",
          "43.174.135.0/24",
          "43.174.136.0/24",
          "43.174.14.0/24",
          "43.174.143.0/24",
          "43.174.146.0/24",
          "43.174.147.0/24",
          "43.174.148.0/24",
          "43.174.15.0/24",
          "43.174.150.0/24",
          "43.174.151.0/24",
          "43.174.152.0/24",
          "43.174.153.0/24",
          "43.174.16.0/24",
          "43.174.175.0/24",
          "43.174.187.0/24",
          "43.174.188.0/24",
          "43.174.192.0/24",
          "43.174.193.0/24",
          "43.174.194.0/24",
          "43.174.195.0/24",
          "43.174.196.0/24",
          "43.174.197.0/24",
          "43.174.198.0/24",
          "43.174.199.0/24",
          "43.174.2.0/24",
          "43.174.200.0/24",
          "43.174.201.0/24",
          "43.174.202.0/24",
          "43.174.203.0/24",
          "43.174.204.0/24",
          "43.174.205.0/24",
          "43.174.206.0/24",
          "43.174.207.0/24",
          "43.174.208.0/24",
          "43.174.209.0/24",
          "43.174.210.0/24",
          "43.174.211.0/24",
          "43.174.212.0/24",
          "43.174.213.0/24",
          "43.174.214.0/24",
          "43.174.215.0/24",
          "43.174.216.0/24",
          "43.174.217.0/24",
          "43.174.218.0/24",
          "43.174.219.0/24",
          "43.174.220.0/24",
          "43.174.221.0/24",
          "43.174.222.0/24",
          "43.174.223.0/24",
          "43.174.224.0/24",
          "43.174.225.0/24",
          "43.174.226.0/24",
          "43.174.227.0/24",
          "43.174.228.0/24",
          "43.174.229.0/24",
          "43.174.230.0/24",
          "43.174.231.0/24",
          "43.174.232.0/24",
          "43.174.233.0/24",
          "43.174.24.0/24",
          "43.174.248.0/24",
          "43.174.249.0/24",
          "43.174.25.0/24",
          "43.174.250.0/24",
          "43.174.251.0/24",
          "43.174.26.0/24",
          "43.174.27.0/24",
          "43.174.28.0/24",
          "43.174.29.0/24",
          "43.174.3.0/24",
          "43.174.31.0/24",
          "43.174.32.0/24",
          "43.174.33.0/24",
          "43.174.34.0/24",
          "43.174.35.0/24",
          "43.174.36.0/24",
          "43.174.37.0/24",
          "43.174.38.0/24",
          "43.174.39.0/24",
          "43.174.4.0/24",
          "43.174.40.0/24",
          "43.174.41.0/24",
          "43.174.42.0/24",
          "43.174.43.0/24",
          "43.174.44.0/24",
          "43.174.45.0/24",
          "43.174.46.0/24",
          "43.174.47.0/24",
          "43.174.48.0/24",
          "43.174.49.0/24",
          "43.174.5.0/24",
          "43.174.50.0/24",
          "43.174.51.0/24",
          "43.174.52.0/24",
          "43.174.53.0/24",
          "43.174.54.0/24",
          "43.174.55.0/24",
          "43.174.56.0/24",
          "43.174.57.0/24",
          "43.174.58.0/24",
          "43.174.6.0/24",
          "43.174.62.0/24",
          "43.174.63.0/24",
          "43.174.66.0/24",
          "43.174.67.0/24",
          "43.174.7.0/24",
          "43.174.70.0/24",
          "43.174.71.0/24",
          "43.174.72.0/24",
          "43.174.73.0/24",
          "43.174.74.0/24",
          "43.174.75.0/24",
          "43.174.76.0/24",
          "43.174.77.0/24",
          "43.174.78.0/24",
          "43.174.79.0/24",
          "43.174.8.0/24",
          "43.174.80.0/24",
          "43.174.81.0/24",
          "43.174.83.0/24",
          "43.174.84.0/24",
          "43.174.86.0/24",
          "43.174.87.0/24",
          "43.174.88.0/24",
          "43.174.9.0/24",
          "43.174.93.0/24",
          "43.174.95.0/24",
          "43.174.96.0/24",
          "43.174.97.0/24",
          "43.174.98.0/24",
          "43.174.99.0/24",
          "43.175.0.0/24",
          "43.175.101.0/24",
          "43.175.102.0/24",
          "43.175.103.0/24",
          "43.175.104.0/24",
          "43.175.107.0/24",
          "43.175.108.0/24",
          "43.175.109.0/24",
          "43.175.110.0/24",
          "43.175.112.0/24",
          "43.175.113.0/24",
          "43.175.114.0/24",
          "43.175.115.0/24",
          "43.175.117.0/24",
          "43.175.118.0/24",
          "43.175.119.0/24",
          "43.175.12.0/24",
          "43.175.120.0/24",
          "43.175.121.0/24",
          "43.175.122.0/24",
          "43.175.124.0/24",
          "43.175.125.0/24",
          "43.175.126.0/24",
          "43.175.127.0/24",
          "43.175.128.0/24",
          "43.175.129.0/24",
          "43.175.130.0/24",
          "43.175.131.0/24",
          "43.175.132.0/24",
          "43.175.133.0/24",
          "43.175.134.0/24",
          "43.175.135.0/24",
          "43.175.136.0/24",
          "43.175.138.0/24",
          "43.175.139.0/24",
          "43.175.140.0/24",
          "43.175.141.0/24",
          "43.175.142.0/24",
          "43.175.144.0/24",
          "43.175.145.0/24",
          "43.175.146.0/24",
          "43.175.147.0/24",
          "43.175.149.0/24",
          "43.175.150.0/24",
          "43.175.151.0/24",
          "43.175.152.0/24",
          "43.175.156.0/24",
          "43.175.157.0/24",
          "43.175.16.0/24",
          "43.175.160.0/24",
          "43.175.161.0/24",
          "43.175.162.0/24",
          "43.175.163.0/24",
          "43.175.164.0/24",
          "43.175.165.0/24",
          "43.175.166.0/24",
          "43.175.167.0/24",
          "43.175.168.0/24",
          "43.175.169.0/24",
          "43.175.17.0/24",
          "43.175.170.0/24",
          "43.175.171.0/24",
          "43.175.172.0/24",
          "43.175.173.0/24",
          "43.175.174.0/23",
          "43.175.178.0/23",
          "43.175.18.0/24",
          "43.175.180.0/24",
          "43.175.181.0/24",
          "43.175.182.0/24",
          "43.175.183.0/24",
          "43.175.184.0/24",
          "43.175.185.0/24",
          "43.175.186.0/24",
          "43.175.187.0/24",
          "43.175.189.0/24",
          "43.175.19.0/24",
          "43.175.191.0/24",
          "43.175.193.0/24",
          "43.175.194.0/24",
          "43.175.196.0/24",
          "43.175.197.0/24",
          "43.175.202.0/24",
          "43.175.203.0/24",
          "43.175.204.0/24",
          "43.175.205.0/24",
          "43.175.206.0/24",
          "43.175.208.0/24",
          "43.175.210.0/24",
          "43.175.211.0/24",
          "43.175.212.0/24",
          "43.175.213.0/24",
          "43.175.214.0/24",
          "43.175.215.0/24",
          "43.175.216.0/24",
          "43.175.217.0/24",
          "43.175.218.0/24",
          "43.175.219.0/24",
          "43.175.22.0/24",
          "43.175.220.0/24",
          "43.175.221.0/24",
          "43.175.222.0/24",
          "43.175.224.0/23",
          "43.175.224.0/24",
          "43.175.225.0/24",
          "43.175.226.0/23",
          "43.175.226.0/24",
          "43.175.227.0/24",
          "43.175.228.0/24",
          "43.175.229.0/24",
          "43.175.23.0/24",
          "43.175.230.0/23",
          "43.175.230.0/24",
          "43.175.231.0/24",
          "43.175.232.0/23",
          "43.175.234.0/24",
          "43.175.235.0/24",
          "43.175.236.0/23",
          "43.175.236.0/24",
          "43.175.237.0/24",
          "43.175.238.0/23",
          "43.175.238.0/24",
          "43.175.24.0/24",
          "43.175.240.0/23",
          "43.175.242.0/23",
          "43.175.242.0/24",
          "43.175.243.0/24",
          "43.175.244.0/23",
          "43.175.246.0/23",
          "43.175.248.0/23",
          "43.175.248.0/24",
          "43.175.249.0/24",
          "43.175.25.0/24",
          "43.175.250.0/23",
          "43.175.250.0/24",
          "43.175.251.0/24",
          "43.175.252.0/23",
          "43.175.252.0/24",
          "43.175.253.0/24",
          "43.175.255.0/24",
          "43.175.28.0/24",
          "43.175.29.0/24",
          "43.175.30.0/24",
          "43.175.32.0/24",
          "43.175.33.0/24",
          "43.175.34.0/24",
          "43.175.36.0/24",
          "43.175.37.0/24",
          "43.175.39.0/24",
          "43.175.40.0/24",
          "43.175.42.0/24",
          "43.175.43.0/24",
          "43.175.44.0/24",
          "43.175.49.0/24",
          "43.175.50.0/24",
          "43.175.52.0/24",
          "43.175.53.0/24",
          "43.175.54.0/24",
          "43.175.55.0/24",
          "43.175.56.0/24",
          "43.175.57.0/24",
          "43.175.58.0/24",
          "43.175.60.0/24",
          "43.175.61.0/24",
          "43.175.65.0/24",
          "43.175.66.0/24",
          "43.175.67.0/24",
          "43.175.68.0/24",
          "43.175.69.0/24",
          "43.175.7.0/24",
          "43.175.71.0/24",
          "43.175.73.0/24",
          "43.175.74.0/24",
          "43.175.75.0/24",
          "43.175.77.0/24",
          "43.175.78.0/24",
          "43.175.79.0/24",
          "43.175.8.0/24",
          "43.175.80.0/24",
          "43.175.82.0/24",
          "43.175.83.0/24",
          "43.175.85.0/24",
          "43.175.86.0/24",
          "43.175.87.0/24",
          "43.175.89.0/24",
          "43.175.93.0/24",
          "43.175.94.0/24",
          "43.175.95.0/24",
          "43.175.96.0/24",
          "43.175.97.0/24",
          "43.175.98.0/24",
          "86.51.92.0/24",
          "98.98.60.0/24",
          "98.98.61.0/24",
          "98.98.62.0/24",
            "49.51.190.0/24",
            "49.51.67.0/24",
        
        
        
        "103.245.222.0/24",
            "104.156.80.0/24",
            "104.156.81.0/24",
            "104.156.82.0/24",
            "104.156.83.0/24",
            "104.156.84.0/24",
            "104.156.85.0/24",
            "104.156.87.0/24",
            "104.156.89.0/24",
            "104.156.89.224/28",
            "104.156.91.0/24",
            "104.156.92.0/24",
            "104.156.92.224/28",
            "104.156.93.0/24",
            "104.156.94.0/24",
            "104.156.95.0/24",
            "104.244.43.0/24",
            "131.125.100.0/24",
            "131.125.101.0/24",
            "131.125.102.0/23",
            "131.125.104.0/23",
            "131.125.106.0/23",
            "131.125.96.0/19",
            "131.125.96.0/23",
            "131.125.98.0/23",
            "140.248.0.0/18",
            "140.248.0.0/22",
            "140.248.10.0/24",
            "140.248.104.0/24",
            "140.248.105.0/24",
            "140.248.106.0/24",
            "140.248.107.0/24",
            "140.248.108.0/24",
            "140.248.109.0/24",
            "140.248.11.0/24",
            "140.248.110.0/24",
            "140.248.12.0/22",
            "140.248.125.0/24",
            "140.248.128.0/18",
            "140.248.16.0/24",
            "140.248.18.0/24",
            "140.248.19.0/24",
            "140.248.192.0/18",
            "140.248.192.0/19",
            "140.248.192.0/24",
            "140.248.193.0/24",
            "140.248.194.0/24",
            "140.248.198.0/24",
            "140.248.199.0/24",
            "140.248.20.0/23",
            "140.248.201.0/24",
            "140.248.202.0/24",
            "140.248.203.0/24",
            "140.248.224.0/19",
            "140.248.224.0/24",
            "140.248.225.0/24",
            "140.248.226.0/24",
            "140.248.227.0/24",
            "140.248.228.0/24",
            "140.248.229.0/24",
            "140.248.24.0/24",
            "140.248.28.0/24",
            "140.248.29.0/24",
            "140.248.30.0/23",
            "140.248.32.0/24",
            "140.248.33.0/24",
            "140.248.34.0/23",
            "140.248.36.0/23",
            "140.248.38.0/24",
            "140.248.39.0/24",
            "140.248.4.0/22",
            "140.248.40.0/24",
            "140.248.41.0/24",
            "140.248.42.0/24",
            "140.248.43.0/24",
            "140.248.44.0/22",
            "140.248.48.0/23",
            "140.248.55.0/24",
            "140.248.56.0/21",
            "140.248.56.0/24",
            "140.248.57.0/24",
            "140.248.58.0/24",
            "140.248.59.0/24",
            "140.248.60.0/24",
            "140.248.61.0/24",
            "140.248.62.0/24",
            "140.248.63.0/24",
            "140.248.65.0/24",
            "140.248.66.0/24",
            "140.248.67.0/24",
            "140.248.67.224/28",
            "140.248.68.0/24",
            "140.248.69.0/24",
            "140.248.70.0/24",
            "140.248.71.0/24",
            "140.248.72.0/24",
            "140.248.73.0/24",
            "140.248.73.224/28",
            "140.248.74.0/24",
            "140.248.75.0/24",
            "140.248.76.0/24",
            "140.248.77.0/24",
            "140.248.78.0/24",
            "140.248.79.0/24",
            "140.248.8.0/24",
            "140.248.80.0/24",
            "140.248.82.0/24",
            "140.248.83.0/24",
            "140.248.83.224/28",
            "140.248.84.0/24",
            "140.248.85.0/24",
            "140.248.86.0/24",
            "140.248.86.224/28",
            "140.248.87.0/24",
            "140.248.88.0/24",
            "140.248.89.0/24",
            "140.248.89.224/28",
            "140.248.9.0/24",
            "140.248.90.0/24",
            "140.248.91.0/24",
            "140.248.97.0/24",
            "140.248.98.0/24",
            "146.75.0.0/17",
            "146.75.0.0/22",
            "146.75.100.0/22",
            "146.75.104.0/22",
            "146.75.108.0/22",
            "146.75.112.0/22",
            "146.75.116.0/22",
            "146.75.12.0/22",
            "146.75.120.0/22",
            "146.75.124.0/22",
            "146.75.128.0/17",
            "146.75.128.0/22",
            "146.75.134.0/23",
            "146.75.136.0/23",
            "146.75.146.0/23",
            "146.75.148.0/22",
            "146.75.152.0/23",
            "146.75.154.0/23",
            "146.75.158.0/23",
            "146.75.16.0/22",
            "146.75.160.0/23",
            "146.75.162.0/23",
            "146.75.164.0/23",
            "146.75.166.0/24",
            "146.75.168.0/24",
            "146.75.169.0/24",
            "146.75.170.0/23",
            "146.75.172.0/23",
            "146.75.174.0/24",
            "146.75.175.0/24",
            "146.75.178.0/24",
            "146.75.179.0/24",
            "146.75.180.0/24",
            "146.75.182.0/24",
            "146.75.184.0/24",
            "146.75.185.0/24",
            "146.75.186.0/24",
            "146.75.187.0/24",
            "146.75.188.0/24",
            "146.75.189.0/24",
            "146.75.190.0/24",
            "146.75.191.0/24",
            "146.75.192.0/23",
            "146.75.195.0/24",
            "146.75.197.0/24",
            "146.75.198.0/24",
            "146.75.199.0/24",
            "146.75.20.0/22",
            "146.75.200.0/24",
            "146.75.201.0/24",
            "146.75.202.0/24",
            "146.75.203.0/24",
            "146.75.206.0/24",
            "146.75.207.0/24",
            "146.75.208.0/24",
            "146.75.209.0/24",
            "146.75.211.0/24",
            "146.75.212.0/24",
            "146.75.213.0/24",
            "146.75.214.0/24",
            "146.75.216.0/24",
            "146.75.217.0/24",
            "146.75.218.0/24",
            "146.75.219.0/24",
            "146.75.220.0/24",
            "146.75.222.0/23",
            "146.75.224.0/24",
            "146.75.226.0/23",
            "146.75.232.0/22",
            "146.75.236.0/22",
            "146.75.24.0/22",
            "146.75.244.0/22",
            "146.75.248.0/22",
            "146.75.252.0/22",
            "146.75.28.0/22",
            "146.75.32.0/22",
            "146.75.36.0/22",
            "146.75.4.0/22",
            "146.75.40.0/22",
            "146.75.44.0/22",
            "146.75.48.0/22",
            "146.75.52.0/22",
            "146.75.60.0/22",
            "146.75.64.0/22",
            "146.75.68.0/22",
            "146.75.72.0/22",
            "146.75.76.0/22",
            "146.75.8.0/22",
            "146.75.80.0/22",
            "146.75.84.0/22",
            "146.75.88.0/22",
            "146.75.92.0/22",
            "146.75.96.0/22",
            "151.101.0.0/16",
            "151.101.0.0/22",
            "151.101.104.0/22",
            "151.101.108.0/22",
            "151.101.112.0/22",
            "151.101.116.0/22",
            "151.101.12.0/22",
            "151.101.120.0/22",
            "151.101.124.0/22",
            "151.101.128.0/22",
            "151.101.132.0/22",
            "151.101.136.0/22",
            "151.101.140.0/22",
            "151.101.144.0/22",
            "151.101.148.0/22",
            "151.101.156.0/22",
            "151.101.16.0/22",
            "151.101.160.0/22",
            "151.101.164.0/22",
            "151.101.172.0/22",
            "151.101.176.0/22",
            "151.101.180.0/22",
            "151.101.188.0/22",
            "151.101.192.0/22",
            "151.101.196.0/22",
            "151.101.20.0/22",
            "151.101.200.0/22",
            "151.101.204.0/22",
            "151.101.208.0/22",
            "151.101.212.0/22",
            "151.101.216.0/22",
            "151.101.220.0/22",
            "151.101.224.0/22",
            "151.101.228.0/22",
            "151.101.232.0/22",
            "151.101.236.0/22",
            "151.101.240.0/22",
            "151.101.244.0/22",
            "151.101.248.0/22",
            "151.101.28.0/22",
            "151.101.36.0/22",
            "151.101.40.0/22",
            "151.101.44.0/22",
            "151.101.48.0/22",
            "151.101.52.0/22",
            "151.101.60.0/22",
            "151.101.64.0/22",
            "151.101.68.0/22",
            "151.101.72.0/22",
            "151.101.76.0/22",
            "151.101.8.0/22",
            "151.101.80.0/22",
            "151.101.88.0/22",
            "151.101.92.0/22",
            "151.101.96.0/22",
            "157.5.100.0/22",
            "157.5.104.0/22",
            "157.5.108.0/22",
            "157.5.112.0/22",
            "157.5.116.0/22",
            "157.5.120.0/24",
            "157.5.122.0/24",
            "157.5.123.0/24",
            "157.5.124.0/24",
            "157.5.64.0/18",
            "157.5.64.0/22",
            "157.5.68.0/24",
            "157.5.69.0/24",
            "157.5.70.0/24",
            "157.5.71.0/24",
            "157.5.72.0/24",
            "157.5.73.0/24",
            "157.5.74.0/24",
            "157.5.76.0/24",
            "157.5.79.0/24",
            "157.5.80.0/24",
            "157.5.81.0/24",
            "157.5.82.0/24",
            "157.5.83.0/24",
            "157.5.84.0/24",
            "157.5.85.0/24",
            "157.5.86.0/24",
            "157.5.87.0/24",
            "157.5.88.0/22",
            "157.5.96.0/22",
            "157.52.103.0/24",
            "157.52.104.0/24",
            "157.52.106.0/24",
            "157.52.108.0/24",
            "157.52.109.0/24",
            "157.52.110.0/24",
            "157.52.112.0/24",
            "157.52.115.0/24",
            "157.52.116.0/24",
            "157.52.117.0/24",
            "157.52.118.0/24",
            "157.52.119.0/24",
            "157.52.120.0/24",
            "157.52.121.0/24",
            "157.52.122.0/24",
            "157.52.123.0/24",
            "157.52.124.0/24",
            "157.52.125.0/24",
            "157.52.64.0/24",
            "157.52.65.0/24",
            "157.52.66.0/24",
            "157.52.67.0/24",
            "157.52.67.224/28",
            "157.52.68.0/24",
            "157.52.69.0/24",
            "157.52.70.0/24",
            "157.52.71.0/24",
            "157.52.72.0/24",
            "157.52.73.0/24",
            "157.52.74.0/24",
            "157.52.75.0/24",
            "157.52.75.192/26",
            "157.52.76.0/24",
            "157.52.78.0/24",
            "157.52.79.0/24",
            "157.52.80.0/24",
            "157.52.81.0/24",
            "157.52.83.0/24",
            "157.52.84.0/24",
            "157.52.85.0/24",
            "157.52.85.224/28",
            "157.52.88.0/24",
            "157.52.89.0/24",
            "157.52.90.0/24",
            "157.52.91.0/24",
            "157.52.92.0/24",
            "157.52.93.0/24",
            "157.52.94.0/24",
            "157.52.96.0/24",
            "157.52.97.0/24",
            "157.52.97.224/28",
            "159.242.243.0/24",
            "162.219.224.0/22",
            "162.219.224.0/24",
            "162.219.225.0/24",
            "162.219.226.0/24",
            "162.219.227.0/24",
            "162.247.243.0/24",
            "167.82.0.0/17",
            "167.82.0.0/22",
            "167.82.108.0/22",
            "167.82.112.0/22",
            "167.82.116.0/22",
            "167.82.12.0/22",
            "167.82.120.0/22",
            "167.82.124.0/22",
            "167.82.130.0/24",
            "167.82.132.0/24",
            "167.82.135.0/24",
            "167.82.136.0/24",
            "167.82.138.0/24",
            "167.82.139.0/24",
            "167.82.139.192/27",
            "167.82.141.0/24",
            "167.82.142.0/24",
            "167.82.143.0/24",
            "167.82.16.0/22",
            "167.82.160.0/24",
            "167.82.161.0/24",
            "167.82.167.0/24",
            "167.82.169.0/24",
            "167.82.170.0/24",
            "167.82.173.0/24",
            "167.82.20.0/22",
            "167.82.224.0/24",
            "167.82.225.0/24",
            "167.82.227.0/24",
            "167.82.228.0/24",
            "167.82.229.0/24",
            "167.82.230.0/24",
            "167.82.231.0/24",
            "167.82.232.0/24",
            "167.82.233.0/24",
            "167.82.234.0/24",
            "167.82.235.0/24",
            "167.82.236.0/24",
            "167.82.237.0/24",
            "167.82.238.0/24",
            "167.82.239.0/24",
            "167.82.24.0/22",
            "167.82.28.0/22",
            "167.82.32.0/22",
            "167.82.36.0/22",
            "167.82.4.0/22",
            "167.82.40.0/22",
            "167.82.44.0/22",
            "167.82.48.0/22",
            "167.82.52.0/22",
            "167.82.56.0/22",
            "167.82.60.0/22",
            "167.82.8.0/22",
            "167.82.80.0/22",
            "167.82.84.0/22",
            "167.82.88.0/22",
            "172.111.112.0/23",
            "172.111.112.0/27",
            "172.111.112.128/26",
            "172.111.114.0/23",
            "172.111.116.0/24",
            "172.111.117.0/24",
            "172.111.120.0/24",
            "172.111.121.0/24",
            "172.111.122.0/24",
            "172.111.123.0/24",
            "172.111.124.0/24",
            "172.111.64.0/18",
            "172.111.64.0/19",
            "172.111.64.0/26",
            "172.111.68.128/25",
            "172.111.69.64/26",
            "172.111.70.128/25",
            "172.111.70.64/28",
            "172.111.71.0/25",
            "172.111.71.128/26",
            "172.111.72.48/28",
            "172.111.73.0/25",
            "172.111.73.192/26",
            "172.111.77.0/26",
            "172.111.77.64/26",
            "172.111.78.0/24",
            "172.111.79.0/24",
            "172.111.80.0/24",
            "172.111.81.0/24",
            "185.199.108.0/22",
            "185.199.108.0/24",
            "185.199.109.0/24",
            "185.199.110.0/24",
            "185.199.111.0/24",
            "185.221.87.0/24",
            "185.31.17.0/24",
            "185.31.18.0/24",
            "198.54.216.0/24",
            "199.232.0.0/16",
            "199.232.100.0/22",
            "199.232.104.0/22",
            "199.232.112.0/22",
            "199.232.136.0/22",
            "199.232.144.0/22",
            "199.232.148.0/22",
            "199.232.152.0/22",
            "199.232.156.0/22",
            "199.232.16.0/22",
            "199.232.164.0/22",
            "199.232.168.0/22",
            "199.232.172.0/22",
            "199.232.176.0/22",
            "199.232.188.0/22",
            "199.232.192.0/22",
            "199.232.196.0/22",
            "199.232.20.0/22",
            "199.232.208.0/22",
            "199.232.212.0/22",
            "199.232.224.0/22",
            "199.232.228.0/22",
            "199.232.232.0/22",
            "199.232.24.0/22",
            "199.232.28.0/22",
            "199.232.32.0/22",
            "199.232.36.0/22",
            "199.232.40.0/22",
            "199.232.44.0/22",
            "199.232.48.0/22",
            "199.232.52.0/22",
            "199.232.56.0/22",
            "199.232.60.0/22",
            "199.232.64.0/22",
            "199.232.68.0/22",
            "199.232.72.0/22",
            "199.232.80.0/22",
            "199.232.88.0/22",
            "199.232.96.0/22",
            "199.27.74.0/24",
            "199.27.75.0/24",
            "199.27.76.0/24",
            "199.27.77.0/24",
            "199.27.79.0/24",
            "199.36.158.0/24",
            "209.102.206.0/24",
            "23.154.64.0/24",
            "23.185.0.0/24",
            "23.235.32.0/24",
            "23.235.33.0/24",
            "23.235.35.0/24",
            "23.235.36.0/24",
            "23.235.37.0/24",
            "23.235.38.0/24",
            "23.235.40.0/24",
            "23.235.43.0/24",
            "23.235.44.0/24",
            "23.235.45.0/24",
            "43.249.73.0/24",
            "43.249.74.0/24",
            "66.211.168.0/24"
    ]
    
    static let regexps: [NSRegularExpression] = {
        let raw = [
        ".*\\.(doubleclick|googleadservices|googlesyndication|google-analytics|adsrvr|adnxs|pubmatic|criteo|casalemedia|openx|rubiconproject|taboola|outbrain|scorecardresearch|quantserve|demdex|krxd)\\..*",
        "^ad[sxvmn]?\\d*[.-].*",
        "^.*[.-]ad[sxvmn]?\\d*[.-].*",
        "^banner[sz]?[.-].*",
        "^.*[.-]banner[sz]?[.-].*",
        "^track(er|ing)?[.-].*",
        "^.*[.-]track(er|ing)?[.-].*",
        "^stat[sz]?[.-].*",
        "^.*[.-]stat[sz]?[.-].*",
        "^analytics?[.-].*",
        "^.*[.-]analytics?[.-].*",
        "^metric[sz]?[.-].*",
        "^.*[.-]metric[sz]?[.-].*",
        "^telemetry[.-].*",
        "^.*[.-]telemetry[.-].*",
        "^pixel[.-].*",
        "^.*[.-]pixel[.-].*",
        "^click[.-].*",
        "^.*[.-]click[.-].*",
        "^counter[.-].*",
        "^.*[.-]counter[.-].*",
        "^beacon[.-].*",
        "^.*[.-]beacon[.-].*"
        ]
        return raw.compactMap { try? NSRegularExpression(pattern: $0, options: [.caseInsensitive]) }
    }()
    
    // ② 解析/匹配辅助 —— 仅 IPv4，够用且无第三方依赖
    @inline(__always)
    private static func ipv4ToUInt32(_ s: String) -> UInt32? {
        // 去掉可能存在的端口，例如 "49.51.1.2:443"
        let host = s.split(separator: ":", maxSplits: 1).first.map(String.init) ?? s
        let parts = host.split(separator: ".", omittingEmptySubsequences: false)
        guard parts.count == 4 else { return nil }
        var val: UInt32 = 0
        for p in parts {
            guard let oct = UInt8(p) else { return nil }
            val = (val << 8) | UInt32(oct)
        }
        return val
    }

    @inline(__always)
    private static func parseIPv4CIDR(_ s: String) -> (net: UInt32, mask: UInt32)? {
        let comps = s.split(separator: "/")
        guard comps.count == 2,
              let ip = ipv4ToUInt32(String(comps[0])),
              let plen = Int(comps[1]), (0...32).contains(plen) else { return nil }
        let mask: UInt32 = (plen == 0) ? 0 : (UInt32.max << (32 - plen))
        return (ip & mask, mask)
    }

    private static let ipv4CIDRs: [(net: UInt32, mask: UInt32)] = {
        var out: [(UInt32, UInt32)] = []
        for raw in ipv4CIDRsRaw {
            if let t = parseIPv4CIDR(raw) { out.append(t) }
        }
        // 如果你保留了 ipv4SinglesRaw，等价于 /32：
        // for ip in ipv4SinglesRaw {
        //     if let v = ipv4ToUInt32(ip) { out.append((v, UInt32.max)) }
        // }
        return out
    }()

    @inline(__always)
    private static func matchesIPv4(_ hostOrIp: String) -> Bool {
        guard let ip = ipv4ToUInt32(hostOrIp) else { return false }
        for (net, mask) in ipv4CIDRs {
            if (ip & mask) == net { return true }
        }
        return false
    }

    // ③ 用下面这个替换原来的 matches(_:)
    @inline(__always)
    static func matches(_ host: String) -> Bool {
        @inline(__always)
        func labelSuffixMatch(_ h: String, _ root: String) -> Bool {
            if h == root { return true }
            return h.hasSuffix("." + root)
        }

        let h = host.lowercased().trimmingCharacters(in: .whitespacesAndNewlines)

        // 先按“域名后缀”判断（保持你现有行为：root 域和任意子域都命中）
        for p in patterns {
            var root = p.lowercased().trimmingCharacters(in: .whitespacesAndNewlines)
            if root.hasPrefix("*.") { root.removeFirst(2) }
            guard !root.isEmpty else { continue }
            if labelSuffixMatch(h, root) { return true }
        }

        // （可选）正则白名单
        for re in regexps {
            let r = NSRange(location: 0, length: h.utf16.count)
            if re.firstMatch(in: h, options: [], range: r) != nil { return true }
        }

        // 最后按 IPv4 / CIDR 判断
        if matchesIPv4(h) { return true }

        return false
    }
}
